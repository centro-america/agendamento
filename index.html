function doPost(e) {
  try {
    const formData = e.parameter;

    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Agendamentos');
    if (!sheet) throw new Error("A aba 'Agendamentos' não foi encontrada.");

    sheet.appendRow([
      new Date(),            // Timestamp
      formData.nome,         // Nome do Responsável
      formData.aluno,        // Nome do Aluno
      formData.turma,        // Turma
      formData.hora,         // ⚠️ Corrigido: Horário primeiro
      formData.data          // ⚠️ Corrigido: Data por último
    ]);

    return ContentService
      .createTextOutput("Agendamento enviado com sucesso!")
      .setMimeType(ContentService.MimeType.TEXT);

  } catch (error) {
    return ContentService
      .createTextOutput("Erro ao processar o agendamento.")
      .setMimeType(ContentService.MimeType.TEXT);
  }
}

function doGet(e) {
  try {
    const dataAlvo = e.parameter.data;
    if (!dataAlvo) throw new Error("Parâmetro 'data' não fornecido.");

    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Agendamentos');
    if (!sheet) throw new Error("A aba 'Agendamentos' não foi encontrada.");

    const dados = sheet.getDataRange().getValues();
    const horariosOcupados = [];

    for (let i = 1; i < dados.length; i++) {
      const data = dados[i][5];     // Coluna "Data do Agendamento"
      const horario = dados[i][4];  // Coluna "Horário"
      if (data === dataAlvo) {
        horariosOcupados.push(horario);
      }
    }

    return ContentService
      .createTextOutput(JSON.stringify(horariosOcupados))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify([]))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
