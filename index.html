<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, query, where } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCK95vSv4jK0L-eoKC2I6Gev5BjQSL3N7c",
    authDomain: "agendamento-c4753.firebaseapp.com",
    projectId: "agendamento-c4753",
    storageBucket: "agendamento-c4753.firebasestorage.app",
    messagingSenderId: "953838698372",
    appId: "1:953838698372:web:f07ca99c97c1ce7d1",
    measurementId: "G-72V3RZG3MF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const horariosManha = [
    "07:10","07:20","07:30","07:40","07:50","08:00",
    "08:10","08:20","08:30","08:40","08:50","09:00",
    "09:10","09:20","09:30","09:40","09:50","10:00",
    "10:10","10:20","10:30","10:40","10:50"
  ];

  const horariosTarde = [
    "13:10","13:20","13:30","13:40","13:50","14:00",
    "14:10","14:20","14:30","14:40","14:50","15:00",
    "15:10","15:20","15:30","15:40","15:50","16:00",
    "16:10","16:20","16:30","16:40","16:50"
  ];

  const turmaSelect = document.getElementById("turma");
  const horarioSelect = document.getElementById("horario");

  function detectarTurno(turma) {
    const match = turma.match(/(TA|TB|TC)/);
    if (match) return "tarde";

    const matchManha = turma.match(/(MA|MB|MC)/);
    if (matchManha) return "manha";

    return "manha"; // valor padrão
  }

  async function carregarHorariosDisponiveis(turma) {
    horarioSelect.innerHTML = "";

    const turno = detectarTurno(turma);
    const horarios = turno === "tarde" ? horariosTarde : horariosManha;

    const q = query(collection(db, "agendamentos"), where("turma", "==", turma));
    const querySnapshot = await getDocs(q);

    const horariosAgendados = new Set();
    querySnapshot.forEach(doc => {
      horariosAgendados.add(doc.data().horario);
    });

    horarios.forEach(horario => {
      const option = document.createElement("option");
      option.value = horario;
      if (horariosAgendados.has(horario)) {
        option.textContent = `${horario} (Indisponível)`;
        option.disabled = true;
      } else {
        option.textContent = horario;
      }
      horarioSelect.appendChild(option);
    });
  }

  turmaSelect.addEventListener("change", () => {
    const turma = turmaSelect.value;
    if (turma) carregarHorariosDisponiveis(turma);
  });

  document.getElementById("agendamento-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const nome = document.getElementById("nome").value.trim();
    const aluno = document.getElementById("aluno").value.trim();
    const turma = turmaSelect.value;
    const horario = horarioSelect.value;

    if (!nome || !aluno || !turma || !horario) {
      alert("Por favor, preencha todos os campos.");
      return;
    }

    try {
      await addDoc(collection(db, "agendamentos"), { nome, aluno, turma, horario });
      alert("Agendamento realizado com sucesso!");
      carregarHorariosDisponiveis(turma);
      document.getElementById("agendamento-form").reset();
      horarioSelect.innerHTML = "";
    } catch (error) {
      console.error("Erro ao salvar agendamento:", error);
      alert("Erro ao realizar agendamento. Tente novamente.");
    }
  });
</script>
