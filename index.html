<script>
    // URL do seu Google Apps Script (substitua pela sua URL real)
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxDqszuYAOMPlatE8roRhm4AKcA5MGQaL3HLJZ8LLJjAQxii50ijrz0C_qkRR-b3gZIKA/exec';

    document.addEventListener('DOMContentLoaded', function() {
        const turmaSelect = document.getElementById('turma');
        const horarioSelect = document.getElementById('horario');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const submitButton = document.getElementById('submitButton');
        const errorMessage = document.getElementById('errorMessage');

        // Gerar todos os horários possíveis (07:10 até 10:50, de 10 em 10 minutos)
        function gerarTodosHorarios() {
            const horarios = [];
            const startHour = 7;
            const startMinute = 10;
            const endHour = 10;
            const endMinute = 50;

            let currentHour = startHour;
            let currentMinute = startMinute;

            while (currentHour < endHour || (currentHour === endHour && currentMinute <= endMinute)) {
                const horaFormatada = currentHour.toString().padStart(2, '0');
                const minutoFormatado = currentMinute.toString().padStart(2, '0');
                horarios.push(`${horaFormatada}:${minutoFormatado}`);

                currentMinute += 10;
                if (currentMinute >= 60) {
                    currentMinute -= 60;
                    currentHour += 1;
                }
            }

            return horarios;
        }

        // Carregar horários ocupados da planilha
        async function carregarHorariosOcupados() {
            try {
                loadingIndicator.style.display = 'block';

                // Adiciona timestamp para evitar cache
                const response = await fetch(`${SCRIPT_URL}?action=getHorarios&timestamp=${new Date().getTime()}`);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const data = await response.json();
                loadingIndicator.style.display = 'none';
                return data;
            } catch (error) {
                console.error('Erro ao carregar horários:', error);
                loadingIndicator.style.display = 'none';
                showError('Erro ao carregar horários disponíveis. Recarregue a página.');
                return {};
            }
        }

        // Mostrar mensagem de erro
        function showError(message) {
            errorMessage.textContent = message || 'Ocorreu um erro. Por favor, tente novamente.';
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        // Atualizar os horários disponíveis quando a turma é selecionada
        async function atualizarHorariosDisponiveis() {
            const turmaSelecionada = turmaSelect.value;
            if (!turmaSelecionada) {
                horarioSelect.innerHTML = '<option value="">Primeiro selecione uma turma</option>';
                horarioSelect.disabled = true;
                return;
            }

            submitButton.disabled = true;
            horarioSelect.disabled = true;
            horarioSelect.innerHTML = '<option value="">Carregando horários...</option>';

            try {
                const [todasTurmas, horariosOcupados] = await Promise.all([
                    gerarTodosHorarios(),
                    carregarHorariosOcupados()
                ]);

                // Limpar select de horários
                horarioSelect.innerHTML = '';

                // Obter horários ocupados para a turma selecionada
                const ocupadosParaTurma = horariosOcupados[turmaSelecionada] || [];

                // Adicionar apenas horários disponíveis
                todasTurmas.forEach(horario => {
                    if (!ocupadosParaTurma.includes(horario)) {
                        const option = document.createElement('option');
                        option.value = horario;
                        option.textContent = horario;
                        horarioSelect.appendChild(option);
                    }
                });

                if (horarioSelect.options.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nenhum horário disponível para esta turma';
                    option.disabled = true;
                    horarioSelect.appendChild(option);
                    submitButton.disabled = true;
                } else {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Selecione um horário...';
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    horarioSelect.insertBefore(defaultOption, horarioSelect.firstChild);
                    submitButton.disabled = false;
                }

                horarioSelect.disabled = false;
            } catch (error) {
                console.error('Erro ao atualizar horários:', error);
                showError('Erro ao carregar horários disponíveis');
                horarioSelect.innerHTML = '<option value="">Erro ao carregar</option>';
            }
        }

        // Função para enviar o agendamento
        async function enviarAgendamento(formData) {
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Erro no fetch:', error);
                throw error;
            }
        }

        // Event listener para mudança de turma
        turmaSelect.addEventListener('change', atualizarHorariosDisponiveis);

        // Configurar o envio do formulário
        document.getElementById('agendamentoForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                responsavel: document.getElementById('responsavel').value.trim(),
                aluno: document.getElementById('aluno').value.trim(),
                turma: document.getElementById('turma').value,
                horario: document.getElementById('horario').value,
                data: new Date().toLocaleString('pt-BR')
            };

            // Validação básica
            if (!formData.responsavel || !formData.aluno || !formData.turma || !formData.horario) {
                showError('Preencha todos os campos obrigatórios');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            try {
                const resultado = await enviarAgendamento(formData);

                if (resultado.status === 'success') {
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('errorMessage').style.display = 'none';
                    document.getElementById('agendamentoForm').reset();

                    setTimeout(() => {
                        document.getElementById('successMessage').style.display = 'none';
                    }, 5000);

                    // Atualizar horários disponíveis após agendamento
                    await atualizarHorariosDisponiveis();
                } else {
                    throw new Error(resultado.message || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro no agendamento:', error);
                showError(error.message || 'Erro ao enviar agendamento. Tente novamente.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Agendar';
            }
        });
    });
</script>
