<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Agendamento</title>
  <style>
    select option[disabled] {
      text-decoration: line-through;
      color: gray;
    }
  </style>
</head>
<body>
  <form id="form-agendamento">
    <label for="responsavel">Responsável:</label>
    <input type="text" id="responsavel" name="responsavel" required><br>

    <label for="aluno">Aluno:</label>
    <input type="text" id="aluno" name="aluno" required><br>

    <label for="turma">Turma:</label>
    <select id="turma" name="turma" required onchange="atualizarHorarios()">
      <option value="">Selecione</option>
      <option value="">Selecione uma turma...</option>
      <option value="Maternal MA - Marilene Soares da Silva Rosa">Maternal MA - Marilene Soares da Silva Rosa</option>
      <option value="Maternal TA - Tatiane Maria Souza da Costa">Maternal TA - Tatiane Maria Souza da Costa</option>
      <option value="Pré 1 MA - Ana Paula">Pré 1 MA - Ana Paula</option>
      <option value="Pré 1 TA - Ana Paula">Pré 1 TA - Ana Paula</option>
      <option value="Pré 1 TB - Rosane Ambrósio de Oliveira dos Santos">Pré 1 TB - Rosane Ambrósio de Oliveira dos Santos</option>
      <option value="Pré 2 MA - Maria Letícia Sousa de Araújo">Pré 2 MA - Maria Letícia Sousa de Araújo</option>
      <option value="Pré 2 TA - Maria Letícia Sousa de Araújo">Pré 2 TA - Maria Letícia Sousa de Araújo</option>
      <option value="Pré 2 TB - Valéria Pereira Belisario de Paula">Pré 2 TB - Valéria Pereira Belisario de Paula</option>
      <option value="Pré 3 MA - Raissa Manoele Costa Pereira">Pré 3 MA - Raissa Manoele Costa Pereira</option>
      <option value="Pré 3 MB - Valéria Pereira Belisario de Paula">Pré 3 MB - Valéria Pereira Belisario de Paula</option>
      <option value="Pré 3 TA - Heulla Fhernanda Menezes">Pré 3 TA - Heulla Fhernanda Menezes</option>
      <option value="Pré 3 TB - Raissa Manoele Costa Pereira">Pré 3 TB - Raissa Manoele Costa Pereira</option>
      <option value="1º ano MA - Eliane Silva dos Santos Cruz">1º ano MA - Eliane Silva dos Santos Cruz</option>
      <option value="1º ano MB - Leticia da Silva Pinheiro">1º ano MB - Leticia da Silva Pinheiro</option>
      <option value="1º ano TA - Eliane Silva dos Santos Cruz">1º ano TA - Eliane Silva dos Santos Cruz</option>
      <option value="1º ano TB - Leticia da Silva Pinheiro">1º ano TB - Leticia da Silva Pinheiro</option>
      <option value="1º ano TC - Nadir de Barros">1º ano TC - Nadir de Barros</option>
    </select><br>

    <label for="horario">Horário:</label>
    <select id="horario" name="horario" required>
      <option value="">Selecione a turma primeiro</option>
    </select><br>

    <button type="submit">Agendar</button>
  </form>

  <script>
    const urlScript = 'https://script.google.com/macros/s/SEU_DEPLOYMENT_URL/exec';

    // Horários possíveis
    const horariosDisponiveis = [
      '13:00', '13:15', '13:30', '13:45', '14:00'
    ];

    async function atualizarHorarios() {
      const turma = document.getElementById('turma').value;
      const selectHorario = document.getElementById('horario');
      selectHorario.innerHTML = ''; // Limpa opções

      if (!turma) {
        selectHorario.innerHTML = '<option value="">Selecione a turma primeiro</option>';
        return;
      }

      try {
        const res = await fetch(`${urlScript}?action=getHorarios`);
        const json = await res.json();
        const ocupados = json.data[turma] || [];

        horariosDisponiveis.forEach(horario => {
          const option = document.createElement('option');
          option.value = horario;

          if (ocupados.includes(horario)) {
            option.disabled = true;
            option.textContent = `${horario} - indisponível`;
            option.style.textDecoration = 'line-through';
          } else {
            option.textContent = horario;
          }

          selectHorario.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao buscar horários:', error);
        alert('Erro ao buscar horários disponíveis. Tente novamente mais tarde.');
      }
    }

    // Envio do formulário
    document.getElementById('form-agendamento').addEventListener('submit', async function(e) {
      e.preventDefault();

      const dados = {
        responsavel: document.getElementById('responsavel').value,
        aluno: document.getElementById('aluno').value,
        turma: document.getElementById('turma').value,
        horario: document.getElementById('horario').value
      };

      try {
        const res = await fetch(urlScript, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        });

        const json = await res.json();

        if (json.status === 'success') {
          alert('Agendamento realizado com sucesso!');
          document.getElementById('form-agendamento').reset();
          atualizarHorarios(); // Atualiza a lista após novo agendamento
        } else {
          alert(json.message || 'Erro ao agendar.');
        }

      } catch (error) {
        console.error('Erro ao enviar dados:', error);
        alert('Erro ao enviar os dados. Tente novamente.');
      }
    });
  </script>
</body>
</html>
